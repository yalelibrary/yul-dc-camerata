version: '3'
services:
  iiif_manifest:
    environment:
      HONEYBADGER_API_KEY_MANIFEST: ${HONEYBADGER_API_KEY_MANIFEST}
      IIIF_IMAGE_BASE_URL:
      IIIF_MANIFESTS_BASE_URL:
      PASSENGER_APP_ENV: ${RAILS_ENV:-production}
      POSTGRES_DB: iiif_manifest_yul_production
      POSTGRES_HOST: ${CLUSTER_NAME}-psql.${CLUSTER_NAME}
      RAILS_ENV: ${RAILS_ENV:-production}
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      SAMPLE_BUCKET:

    # This is a workaround to create the needed database for iiif_manifest on an existing cluster.
    # We are pre-pending the database creation command to the passenger start command that it otherwise
    # inherits from the base docker image.
    command: bash -c "bundle exec rake db:create && /sbin/my_init"
    logging:
      driver: awslogs
      options:
        awslogs-group: ${CLUSTER_NAME}
        awslogs-region: ${AWS_DEFAULT_REGION}
        awslogs-stream-prefix: iiif_manifest
